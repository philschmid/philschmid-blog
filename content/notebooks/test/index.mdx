---
title: BERT Text Classification on a GPU with HuggingFace and Trainer Class
author: Philipp Schmid
date: 2020-08-04
hero: ./images/cover.jpg
excerpt:
  Automatic deploy your React, Vue, Angular or Svelte app on s3 and create a
  cache Invalidation with Github Actions.
tag:
  - BERT
photograph: Photo by Tim Swaan on Unsplash
---

TODO:

- test erst wandb initalisieren und dann transformers

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/drive/1y0JUDLLkTqs2arGZmJgk6WmpCIeLmuoQ?usp=sharing)

```bash
# run this cell, then restart the runtime before continuing
#!pip install git+https://github.com/joeddav/transformers.git@data-collator-type-fix
#returns error Expected object of scalar type Long but got scalar type Float for argument #2 'target' in call to _thnn_nll_loss_forward
#!pip install transformers --upgrade
!pip install transformers==3.0.2

!pip install wandb
#!pip install nlp
#import pyarrow
#if int(pyarrow.__version__.split('.')[1]) < 16:
#    import os
#    os.kill(os.getpid(), 9)
```

    Collecting transformers==3.0.2
    [?25l  Downloading https://files.pythonhosted.org/packages/27/3c/91ed8f5c4e7ef3227b4119200fc0ed4b4fd965b1f0172021c25701087825/transformers-3.0.2-py3-none-any.whl (769kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 778kB 3.4MB/s
    [?25hRequirement already satisfied: numpy in /usr/local/lib/python3.6/dist-packages (from transformers==3.0.2) (1.18.5)
    Collecting tokenizers==0.8.1.rc1
    [?25l  Downloading https://files.pythonhosted.org/packages/40/d0/30d5f8d221a0ed981a186c8eb986ce1c94e3a6e87f994eae9f4aa5250217/tokenizers-0.8.1rc1-cp36-cp36m-manylinux1_x86_64.whl (3.0MB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3.0MB 16.0MB/s
    [?25hCollecting sacremoses
    [?25l  Downloading https://files.pythonhosted.org/packages/7d/34/09d19aff26edcc8eb2a01bed8e98f13a1537005d31e95233fd48216eed10/sacremoses-0.0.43.tar.gz (883kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 890kB 30.6MB/s
    [?25hRequirement already satisfied: packaging in /usr/local/lib/python3.6/dist-packages (from transformers==3.0.2) (20.4)
    Requirement already satisfied: tqdm>=4.27 in /usr/local/lib/python3.6/dist-packages (from transformers==3.0.2) (4.41.1)
    Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.6/dist-packages (from transformers==3.0.2) (2019.12.20)
    Collecting sentencepiece!=0.1.92
    [?25l  Downloading https://files.pythonhosted.org/packages/d4/a4/d0a884c4300004a78cca907a6ff9a5e9fe4f090f5d95ab341c53d28cbc58/sentencepiece-0.1.91-cp36-cp36m-manylinux1_x86_64.whl (1.1MB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1.1MB 36.8MB/s
    [?25hRequirement already satisfied: filelock in /usr/local/lib/python3.6/dist-packages (from transformers==3.0.2) (3.0.12)
    Requirement already satisfied: requests in /usr/local/lib/python3.6/dist-packages (from transformers==3.0.2) (2.23.0)
    Requirement already satisfied: dataclasses; python_version < "3.7" in /usr/local/lib/python3.6/dist-packages (from transformers==3.0.2) (0.7)
    Requirement already satisfied: six in /usr/local/lib/python3.6/dist-packages (from sacremoses->transformers==3.0.2) (1.12.0)
    Requirement already satisfied: click in /usr/local/lib/python3.6/dist-packages (from sacremoses->transformers==3.0.2) (7.1.2)
    Requirement already satisfied: joblib in /usr/local/lib/python3.6/dist-packages (from sacremoses->transformers==3.0.2) (0.16.0)
    Requirement already satisfied: pyparsing>=2.0.2 in /usr/local/lib/python3.6/dist-packages (from packaging->transformers==3.0.2) (2.4.7)
    Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.6/dist-packages (from requests->transformers==3.0.2) (1.24.3)
    Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.6/dist-packages (from requests->transformers==3.0.2) (2.10)
    Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.6/dist-packages (from requests->transformers==3.0.2) (3.0.4)
    Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.6/dist-packages (from requests->transformers==3.0.2) (2020.6.20)
    Building wheels for collected packages: sacremoses
      Building wheel for sacremoses (setup.py) ... [?25l[?25hdone
      Created wheel for sacremoses: filename=sacremoses-0.0.43-cp36-none-any.whl size=893260 sha256=737a89372654ee6cab067f980c325efdc6ef099794f5132c72f5fa7efcc85d4e
      Stored in directory: /root/.cache/pip/wheels/29/3c/fd/7ce5c3f0666dab31a50123635e6fb5e19ceb42ce38d4e58f45
    Successfully built sacremoses
    Installing collected packages: tokenizers, sacremoses, sentencepiece, transformers
    Successfully installed sacremoses-0.0.43 sentencepiece-0.1.91 tokenizers-0.8.1rc1 transformers-3.0.2
    Collecting wandb
    [?25l  Downloading https://files.pythonhosted.org/packages/b4/8c/683d6112dfeaca2c6bc47ef6b4a92b60a310e5054df90bd8d920d6c7a275/wandb-0.9.3-py2.py3-none-any.whl (1.4MB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1.4MB 3.5MB/s
    [?25hCollecting GitPython>=1.0.0
    [?25l  Downloading https://files.pythonhosted.org/packages/f9/1e/a45320cab182bf1c8656107b3d4c042e659742822fc6bff150d769a984dd/GitPython-3.1.7-py3-none-any.whl (158kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 163kB 18.9MB/s
    [?25hRequirement already satisfied: psutil>=5.0.0 in /usr/local/lib/python3.6/dist-packages (from wandb) (5.4.8)
    Collecting gql==0.2.0
      Downloading https://files.pythonhosted.org/packages/c4/6f/cf9a3056045518f06184e804bae89390eb706168349daa9dff8ac609962a/gql-0.2.0.tar.gz
    Collecting subprocess32>=3.5.3
    [?25l  Downloading https://files.pythonhosted.org/packages/32/c8/564be4d12629b912ea431f1a50eb8b3b9d00f1a0b1ceff17f266be190007/subprocess32-3.5.4.tar.gz (97kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 102kB 7.7MB/s
    [?25hCollecting shortuuid>=0.5.0
      Downloading https://files.pythonhosted.org/packages/25/a6/2ecc1daa6a304e7f1b216f0896b26156b78e7c38e1211e9b798b4716c53d/shortuuid-1.0.1-py3-none-any.whl
    Requirement already satisfied: Click>=7.0 in /usr/local/lib/python3.6/dist-packages (from wandb) (7.1.2)
    Collecting sentry-sdk>=0.4.0
    [?25l  Downloading https://files.pythonhosted.org/packages/fb/52/e2604ee8f48219ddb177fffd222f9ed54e684621922ed2f9be85a7481929/sentry_sdk-0.16.1-py2.py3-none-any.whl (107kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 112kB 10.0MB/s
    [?25hCollecting watchdog>=0.8.3
    [?25l  Downloading https://files.pythonhosted.org/packages/0e/06/121302598a4fc01aca942d937f4a2c33430b7181137b35758913a8db10ad/watchdog-0.10.3.tar.gz (94kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 102kB 8.0MB/s
    [?25hCollecting configparser>=3.8.1
      Downloading https://files.pythonhosted.org/packages/4b/6b/01baa293090240cf0562cc5eccb69c6f5006282127f2b846fad011305c79/configparser-5.0.0-py3-none-any.whl
    Requirement already satisfied: nvidia-ml-py3>=7.352.0 in /usr/local/lib/python3.6/dist-packages (from wandb) (7.352.0)
    Requirement already satisfied: requests>=2.0.0 in /usr/local/lib/python3.6/dist-packages (from wandb) (2.23.0)
    Collecting docker-pycreds>=0.4.0
      Downloading https://files.pythonhosted.org/packages/f5/e8/f6bd1eee09314e7e6dee49cbe2c5e22314ccdb38db16c9fc72d2fa80d054/docker_pycreds-0.4.0-py2.py3-none-any.whl
    Requirement already satisfied: six>=1.10.0 in /usr/local/lib/python3.6/dist-packages (from wandb) (1.12.0)
    Requirement already satisfied: python-dateutil>=2.6.1 in /usr/local/lib/python3.6/dist-packages (from wandb) (2.8.1)
    Requirement already satisfied: PyYAML>=3.10 in /usr/local/lib/python3.6/dist-packages (from wandb) (3.13)
    Collecting gitdb<5,>=4.0.1
    [?25l  Downloading https://files.pythonhosted.org/packages/48/11/d1800bca0a3bae820b84b7d813ad1eff15a48a64caea9c823fc8c1b119e8/gitdb-4.0.5-py3-none-any.whl (63kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 71kB 8.5MB/s
    [?25hCollecting graphql-core<2,>=0.5.0
    [?25l  Downloading https://files.pythonhosted.org/packages/b0/89/00ad5e07524d8c523b14d70c685e0299a8b0de6d0727e368c41b89b7ed0b/graphql-core-1.1.tar.gz (70kB)
    [K     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 71kB 6.9MB/s
    [?25hRequirement already satisfied: promise<3,>=2.0 in /usr/local/lib/python3.6/dist-packages (from gql==0.2.0->wandb) (2.3)
    Requirement already satisfied: urllib3>=1.10.0 in /usr/local/lib/python3.6/dist-packages (from sentry-sdk>=0.4.0->wandb) (1.24.3)
    Requirement already satisfied: certifi in /usr/local/lib/python3.6/dist-packages (from sentry-sdk>=0.4.0->wandb) (2020.6.20)
    Collecting pathtools>=0.1.1
      Downloading https://files.pythonhosted.org/packages/e7/7f/470d6fcdf23f9f3518f6b0b76be9df16dcc8630ad409947f8be2eb0ed13a/pathtools-0.1.2.tar.gz
    Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.6/dist-packages (from requests>=2.0.0->wandb) (2.10)
    Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.6/dist-packages (from requests>=2.0.0->wandb) (3.0.4)
    Collecting smmap<4,>=3.0.1
      Downloading https://files.pythonhosted.org/packages/b0/9a/4d409a6234eb940e6a78dfdfc66156e7522262f5f2fecca07dc55915952d/smmap-3.0.4-py2.py3-none-any.whl
    Building wheels for collected packages: gql, subprocess32, watchdog, graphql-core, pathtools
      Building wheel for gql (setup.py) ... [?25l[?25hdone
      Created wheel for gql: filename=gql-0.2.0-cp36-none-any.whl size=7630 sha256=d52c4513efefb8b8ae6e69b4bbcb7cf40ec5322e3a14ee291d3aee166006a34d
      Stored in directory: /root/.cache/pip/wheels/ce/0e/7b/58a8a5268655b3ad74feef5aa97946f0addafb3cbb6bd2da23
      Building wheel for subprocess32 (setup.py) ... [?25l[?25hdone
      Created wheel for subprocess32: filename=subprocess32-3.5.4-cp36-none-any.whl size=6489 sha256=6d462093187f9f9888dc27d234633bf351e7e584a3abd7e7b229b409446c6ebb
      Stored in directory: /root/.cache/pip/wheels/68/39/1a/5e402bdfdf004af1786c8b853fd92f8c4a04f22aad179654d1
      Building wheel for watchdog (setup.py) ... [?25l[?25hdone
      Created wheel for watchdog: filename=watchdog-0.10.3-cp36-none-any.whl size=73870 sha256=8e1eefd472114c89b0f6a343841d7003e2af4f32fd77402ee5647fb545319a29
      Stored in directory: /root/.cache/pip/wheels/a8/1d/38/2c19bb311f67cc7b4d07a2ec5ea36ab1a0a0ea50db994a5bc7
      Building wheel for graphql-core (setup.py) ... [?25l[?25hdone
      Created wheel for graphql-core: filename=graphql_core-1.1-cp36-none-any.whl size=104650 sha256=e3a030e4f349b28e43de5827eaa52c76cd1fc3ddf81ee85b108fda7a78049c6a
      Stored in directory: /root/.cache/pip/wheels/45/99/d7/c424029bb0fe910c63b68dbf2aa20d3283d023042521bcd7d5
      Building wheel for pathtools (setup.py) ... [?25l[?25hdone
      Created wheel for pathtools: filename=pathtools-0.1.2-cp36-none-any.whl size=8784 sha256=4f440d6fca95f2d3acc298bd73585dc159597c06168bfdbc6c60cd1e0ddd5787
      Stored in directory: /root/.cache/pip/wheels/0b/04/79/c3b0c3a0266a3cb4376da31e5bfe8bba0c489246968a68e843
    Successfully built gql subprocess32 watchdog graphql-core pathtools
    Installing collected packages: smmap, gitdb, GitPython, graphql-core, gql, subprocess32, shortuuid, sentry-sdk, pathtools, watchdog, configparser, docker-pycreds, wandb
    Successfully installed GitPython-3.1.7 configparser-5.0.0 docker-pycreds-0.4.0 gitdb-4.0.5 gql-0.2.0 graphql-core-1.1 pathtools-0.1.2 sentry-sdk-0.16.1 shortuuid-1.0.1 smmap-3.0.4 subprocess32-3.5.4 wandb-0.9.3 watchdog-0.10.3

## We need 16gb memory Tesla P100

```
!nvidia-smi
```

    Thu Jul 16 11:06:24 2020
    +-----------------------------------------------------------------------------+
    | NVIDIA-SMI 450.51.05    Driver Version: 418.67       CUDA Version: 10.1     |
    |-------------------------------+----------------------+----------------------+
    | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
    | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
    |                               |                      |               MIG M. |
    |===============================+======================+======================|
    |   0  Tesla K80           Off  | 00000000:00:04.0 Off |                    0 |
    | N/A   35C    P8    30W / 149W |      0MiB / 11441MiB |      0%      Default |
    |                               |                      |                 ERR! |
    +-------------------------------+----------------------+----------------------+

    +-----------------------------------------------------------------------------+
    | Processes:                                                                  |
    |  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
    |        ID   ID                                                   Usage      |
    |=============================================================================|
    |  No running processes found                                                 |
    +-----------------------------------------------------------------------------+

# Weights and Biases

```
import wandb
wandb.login()
```

    <IPython.core.display.Javascript object>


    [34m[1mwandb[0m: Appending key for api.wandb.ai to your netrc file: /root/.netrc





    True

```
import os

os.environ['WANDB_PROJECT']= 'hug-1-text'
os.environ['WANDB_WATCH'] ='all'
```

# Enable Logging

```
import logging


logger = logging.getLogger(__name__)

logging.basicConfig(
    format="%(asctime)s - %(levelname)s - %(name)s -   %(message)s",
    datefmt="%m/%d/%Y %H:%M:%S")
```

```
from transformers import DistilBertForSequenceClassification, DistilBertTokenizerFast, Trainer, TrainingArguments, trainer_utils
#from nlp import load_dataset
import torch
import numpy as np
from sklearn.metrics import accuracy_score, precision_recall_fscore_support
import transformers

transformers.__version__
```

    '3.0.2'

```
model = DistilBertForSequenceClassification.from_pretrained('distilbert-base-uncased',num_labels=4)
tokenizer = DistilBertTokenizerFast.from_pretrained("distilbert-base-uncased")

```

    HBox(children=(FloatProgress(value=0.0, description='Downloading', max=442.0, style=ProgressStyle(description_â€¦






    HBox(children=(FloatProgress(value=0.0, description='Downloading', max=267967963.0, style=ProgressStyle(descriâ€¦





    07/16/2020 11:06:49 - WARNING - transformers.modeling_utils -   Some weights of the model checkpoint at distilbert-base-uncased were not used when initializing DistilBertForSequenceClassification: ['vocab_transform.weight', 'vocab_transform.bias', 'vocab_layer_norm.weight', 'vocab_layer_norm.bias', 'vocab_projector.weight', 'vocab_projector.bias']
    - This IS expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPretraining model).
    - This IS NOT expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
    07/16/2020 11:06:49 - WARNING - transformers.modeling_utils -   Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: ['pre_classifier.weight', 'pre_classifier.bias', 'classifier.weight', 'classifier.bias']
    You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.



    HBox(children=(FloatProgress(value=0.0, description='Downloading', max=231508.0, style=ProgressStyle(descriptiâ€¦

```
from torch.utils.data import Dataset
import torch

class NewsDataset(Dataset):
    def __init__(self, dataframe, tokenizer, max_len):
        self.len = len(dataframe)
        self.data = dataframe
        self.tokenizer = tokenizer
        self.max_len = max_len

    def __getitem__(self, index):
        text = str(self.data.text[index])
        #inputs = self.tokenizer(text, padding=True, truncation=True, max_length=self.max_len, return_tensors="pt")
        inputs = self.tokenizer.encode_plus(
                  text,
                  max_length=self.max_len,
                  pad_to_max_length=True,
                  return_tensors="pt",
                  truncation=True
              )
        ids = inputs['input_ids'].flatten()
        mask = inputs['attention_mask'].flatten()
        label = torch.tensor(int(self.data.label[index]), dtype=torch.long)
        return {
            'input_ids': ids,
            'attention_mask': mask,
            'label': label
        }

    def __len__(self):
        return self.len



from sklearn.datasets import fetch_20newsgroups
import pandas as pd

def load_dataset(subset='train',random_state=42,shuffle=True,categories=None):
    dataset = fetch_20newsgroups(subset=subset,random_state=random_state,
                                          shuffle=shuffle, categories=categories,
                                          remove=('headers', 'footers', 'quotes'))

    df = pd.DataFrame([dataset.data, dataset.target.tolist()]).T
    df.columns = ['text', 'label']


    label_id_dict = {idx: val for idx,val in enumerate(dataset.target_names)}
    return df,label_id_dict
```

```
categories = ['alt.atheism', 'soc.religion.christian',
            'comp.graphics', 'sci.med']

train,_ = load_dataset(categories=categories)
test,_ = load_dataset(categories=categories,subset='test')

train_dataset = NewsDataset(train,tokenizer,512)
test_dataset = NewsDataset(test,tokenizer,512)
```

    Downloading 20news dataset. This may take a few minutes.
    07/16/2020 11:06:52 - INFO - sklearn.datasets._twenty_newsgroups -   Downloading 20news dataset. This may take a few minutes.
    Downloading dataset from https://ndownloader.figshare.com/files/5975967 (14 MB)
    07/16/2020 11:06:52 - INFO - sklearn.datasets._twenty_newsgroups -   Downloading dataset from https://ndownloader.figshare.com/files/5975967 (14 MB)

```
def compute_metrics(pred):
    labels = pred.label_ids
    preds = pred.predictions.argmax(-1)
    precision, recall, f1, _ = precision_recall_fscore_support(labels, preds, average='micro')
    acc = accuracy_score(labels, preds)
    return {
        'accuracy': acc,
        'f1': f1,
        'precision': precision,
        'recall': recall
    }

training_args = TrainingArguments(
    output_dir='./results',
    num_train_epochs=15,
    #per_device_train_batch_size=16,
    per_device_train_batch_size=8,
    per_device_eval_batch_size=8,
    warmup_steps=500,
    weight_decay=0.01,
    evaluate_during_training=True,
    logging_dir='new-test',
    logging_steps=50,
    fp16= False,
    #learning_rate = 1e-4,
)

trainer = Trainer(
    model=model,
    args=training_args,
    compute_metrics=compute_metrics,
    train_dataset=train_dataset,
    eval_dataset=test_dataset
)
```

Logging results to <a href="https://wandb.com" target="_blank">Weights &
Biases</a>

<a href="https://docs.wandb.com/integrations/jupyter.html" target="_blank">
  (Documentation)
</a>.
<br />
Project
page:
<a href="https://app.wandb.ai/schmidcoc/hug-1-text" target="_blank">
  https://app.wandb.ai/schmidcoc/hug-1-text
</a>
<br />
Run
page:
<a
  href="https://app.wandb.ai/schmidcoc/hug-1-text/runs/36i3oxne"
  target="_blank"
>
  https://app.wandb.ai/schmidcoc/hug-1-text/runs/36i3oxne
</a>
<br />

```
trainer.train()
```

    HBox(children=(FloatProgress(value=0.0, description='Epoch', max=15.0, style=ProgressStyle(description_width='â€¦



    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦


    /usr/local/lib/python3.6/dist-packages/torch/optim/lr_scheduler.py:200: UserWarning: Please also save or load the state of the optimzer when saving or loading the scheduler.
      warnings.warn(SAVE_STATE_WARNING, UserWarning)






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦



    HBox(children=(FloatProgress(value=0.0, description='Evaluation', max=188.0, style=ProgressStyle(description_wâ€¦







    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦



    HBox(children=(FloatProgress(value=0.0, description='Evaluation', max=188.0, style=ProgressStyle(description_wâ€¦







    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦



    HBox(children=(FloatProgress(value=0.0, description='Evaluation', max=188.0, style=ProgressStyle(description_wâ€¦







    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦






    HBox(children=(FloatProgress(value=0.0, description='Iteration', max=283.0, style=ProgressStyle(description_wiâ€¦

```
trainer.evaluate()
```

```

```
